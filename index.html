<!doctype html>
<html>
  <head>
    <title>Dancer in the Dark</title>
    <link rel="stylesheet" type="text/css" href="css/reset.css" />
    <link rel="stylesheet" type="text/css" href="css/base.css" />
    <link rel="stylesheet" type="text/css" href="css/constructions.css" />
    <link rel="stylesheet" type="text/css" href="css/decorations.css" />
    <link rel="stylesheet" type="text/css" href="css/humans.css" />
    <style></style>
  </head>
  <body>
    <!-- include these in the project -->
    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <script>
      $(function () {
        const isAtHome = false

        const socket = io()

        const KEY = {
          LEFT: 37,
          UP: 38,
          RIGHT: 39,
          DOWN: 40
        }

        const ALLOWED_KEYCODES = [KEY.LEFT, KEY.UP, KEY.RIGHT, KEY.DOWN];

        $('body').on('keydown', function(key) {
          emitKeyDown(key.keyCode)
          if (ALLOWED_KEYCODES.includes(key.keyCode)) {
            // Prevents page from moving around from arrow keys
            return false
          }
        })

        function emitKeyDown(keyCode) {
          if (ALLOWED_KEYCODES.includes(keyCode)) {
            socket.emit('client key down', keyCode);
          }
        }

        socket.on('map', map => {
          // TODO: clean up, create viewport, cache these
          $('#map-container').html(arrayToHTMLTable(map))
        });

        socket.on('players', players => {
          // each player needs to be drawn, or just draw the updated player?????
          // TODO: need to clear before we draw
          // Should we store the array passed back and redraw the table?
          $('#map').find('td').html('')

          players.forEach((player, playerId) => {
            drawPlayer(playerId, player.x, player.y)
          })
        })

        // TODO: make this into a class, and give it an update method
        let playerId = null
        let turn = null
        let playerNames = []

        socket.on('playerId', passedPlayerId => {
          playerId = passedPlayerId
        })

        socket.on('turn', passedTurn => {
          $('#turn').html(passedTurn)
          turn = passedTurn
          updatePlayerNames()
        })

        socket.on('playerNames', passedPlayerNames => {
          // TODO: change this to include index as well as name??
          playerNames = passedPlayerNames
          updatePlayerNames()
        })

        function updatePlayerNames () {
          if (playerNames === [] || turn === null || playerId === null) {
            $('#player-names').html('<ul></ul>')
            return
          }
          // TODO: do we need to add a templating engine now? lol.
          // yeeee, so much to do. Just focus on this and then switch to using Vue or React
          let builtList = '<ul>'
          let classes = []
          playerNames.forEach((player, index) => {
            classes = []
            if (index === playerNames.indexOf(playerId)) {
              classes.push('you')
            } else if (index === turn) {
              classes.push('turn')
            }
            builtList += `<li class="${classes.join(' ')}">${player}</li>`
          })
          builtList += '</ul>'
          // TODO: better styles for this
          $('#player-names').html(builtList)
        }

        function drawPlayer (playerId, x, y) {
          // TODO: classes, IDs, etc
          // TODO: less hacky garbage
          // const playerClass = `human_${playerId + 1}`
          if (playerId === 0) {
            playerClass = 'player1'
          } else if (playerId === 1) {
            playerClass = 'player2'
          }

          $('#map').find(`tr:eq(${y})`).find(`td:eq(${x})`).html(`<div class="tile ${playerClass}"></div>`)
        }

        function arrayToHTMLTable (array) {
          // TODO: this is a hot mess. Improve this?
          let derp = '<table id="map">'
            array.forEach(row => {
              derp += '<tr>'
              row.forEach(columnItem => {
                derp += `<td class="tile ${cellClass(columnItem)}"></td>`
              })
              derp += '</tr>'
            })
          derp += '</table>'
          return derp
        }

        // TODO: check a cookie for this value
        // run this from the command line to turn on sprites
        function home () {
          isAtHome = true
        }

        function cellClass (cellCode) {
          // For developing where we don't want the sprites shown, tee hee
          if (!isAtHome) {
            if (cellCode === ' ') {
              return 'floor'
            } else if (cellCode === '0') {
              return 'unknown'
            } else if ('─│└┌┐┘├┤┬┴┼?.'.includes(cellCode)) {
              return 'wall'
            } else if ('^'.includes(cellCode)) {
              return 'treasure'
            }
          } else {
            if (cellCode === ' ') {
              return 'decoration_1' // floor
            } else if (cellCode === '0') {
              return 'unknown'
            }

            return 'basic_' + ('─│└┌┐┘├┤┬┴┼?.'.indexOf(cellCode) + 1)
          }
        }
      });
    </script>
    <style>
    #page {
      background: #fff;
      width: 100%;
      height: 100%;
    }
    /* work */
    .tile {
      background-color: #efefef;
    }

    .floor {
      background-color: #ddd;
    }

    .wall {
      background-color: #bbb;
    }

    .player1 {
      background-color: #eee;
    }

    .player2 {
      background-color: #eeb;
    }

    .tile.treasure {
      background-color: #fb6;
    }

    .tile.unknown {
      background-color: #333;
    }

    /* TODO: list styles */
    .you {
      font-weight: bold;
    }

    .turn {
      /* TODO: text decoration? */
      color: #ccc;
    }
    </style>
    <div id="page">
      <div id="turn-container">
        <div id="turn">(this is for testing and will be removed)</div>
        <div id="player-names">Waiting for players</div>
      </div>
      <div id="map-container"></div>
    </div>
  </body>
</html>
