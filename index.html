<!doctype html>
<html>
  <head>
    <title>Dancer in the Dark</title>
    <link rel="stylesheet" type="text/css" href="css/reset.css" />
    <link rel="stylesheet" type="text/css" href="css/base.css" />
    <link rel="stylesheet" type="text/css" href="css/constructions.css" />
    <link rel="stylesheet" type="text/css" href="css/decorations.css" />
    <link rel="stylesheet" type="text/css" href="css/humans.css" />
    <style></style>
  </head>
  <body>
    <!-- include these in the project -->
    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <script>
      $(function () {
        const isAtHome = false

        const socket = io()

        const KEY = {
          LEFT: 37,
          UP: 38,
          RIGHT: 39,
          DOWN: 40,
          SPACEBAR: 32
        }

        const ALLOWED_KEYCODES = [KEY.LEFT, KEY.UP, KEY.RIGHT, KEY.DOWN, KEY.SPACEBAR];

        $('body').on('keydown', function(key) {
          emitKeyDown(key.keyCode)
          if (ALLOWED_KEYCODES.includes(key.keyCode)) {
            // Prevents page from moving around from arrow keys
            return false
          }
        })

        function emitKeyDown(keyCode) {
          if (ALLOWED_KEYCODES.includes(keyCode)) {
            socket.emit('client key down', keyCode);
          }
        }

        socket.on('message', message => {
          // TODO: cache in jQuery
          // TODO: seriously, do this. Look at how many times you are using message-container, lol
          $('#message-container ul').append(`<li>${message}</li>`)
          // TODO: possibly remove some if there are too many?
          // TODO: animate a flash when a new message is added
          // TODO: scroll only if currently at the bottom?
          $('#message-container').animate({
            scrollTop: $('#message-container').prop('scrollHeight') - $('#message-container').height()
          }, 1000)
        })

        socket.on('map', map => {
          // TODO: clean up, create viewport, jQuery cache these
          $('#map-container').html(arrayToHTMLTable(map))
        });

        socket.on('players', players => {
          // each player needs to be drawn, or just draw the updated player?????
          // TODO: need to clear before we draw
          // Should we store the array passed back and redraw the table?
          $('#map').find('td').html('')

          players.forEach((player, playerId) => {
            drawPlayer(playerId, player.x, player.y)
          })
        })

        // TODO: make this into a class, and give it an update method
        let playerId = null
        let turn = null
        let playersPublicInfo = []

        socket.on('playerId', passedPlayerId => {
          playerId = passedPlayerId
        })

        socket.on('turn', passedTurn => {
          turn = passedTurn
          updatePlayerNames()
        })

        socket.on('playersPublicInfo', passedPlayerPublicInfo => {
          // TODO: change this to include index as well as name??
          playersPublicInfo = passedPlayerPublicInfo
          updatePlayerNames()
        })

        function updatePlayerNames () {
          if (playersPublicInfo === [] || turn === null || playerId === null) {
            return
          }
          // TODO: do we need to add a templating engine now? lol.
          // yeeee, so much to do. Just focus on this and then switch to using Vue or React
          let builtList = ''
          let classes = []
          let isYou = false
          let isTurn = false
          playersPublicInfo.forEach((player, index) => {
            classes = []
            isYou = index === playersPublicInfo.map(ppi => ppi.id).indexOf(playerId)
            isTurn = index === turn
            if (isYou) {
              classes.push('you')
            }
            if (isTurn) {
              classes.push('current-turn')
            }
            builtList += `<li class="${classes.join(' ')}">${isTurn ? '→' : ''}${isYou ? '(YOU) ' : ''}${player.name}</li><!--${player.id}-->`
          })
          // TODO: better styles for this
          $('#player-list-container ul').html(builtList)
        }

        function drawPlayer (playerId, x, y) {
          // TODO: classes, IDs, etc
          // TODO: less hacky garbage
          // const playerClass = `human_${playerId + 1}`
          if (playerId === 0) {
            playerClass = 'player1'
          } else if (playerId === 1) {
            playerClass = 'player2'
          }

          $('#map').find(`tr:eq(${y})`).find(`td:eq(${x})`).html(`<div class="tile ${playerClass}"></div>`)
        }

        function arrayToHTMLTable (array) {
          // TODO: this is a hot mess. Improve this?
          let derp = '<table id="map">'
            array.forEach(row => {
              derp += '<tr>'
              row.forEach(columnItem => {
                derp += `<td class="tile ${cellClass(columnItem)}"></td>`
              })
              derp += '</tr>'
            })
          derp += '</table>'
          return derp
        }

        // TODO: check a cookie for this value
        // run this from the command line to turn on sprites
        function home () {
          isAtHome = true
        }

        function cellClass (cellCode) {
          // For developing where we don't want the sprites shown, tee hee
          if (!isAtHome) {
            if (cellCode === ' ') {
              return 'floor'
            } else if (cellCode === '0') {
              return 'unknown'
            } else if ('─│└┌┐┘├┤┬┴┼?.'.includes(cellCode)) {
              return 'wall'
            } else if ('^'.includes(cellCode)) {
              return 'treasure'
            } else if ('#'.includes(cellCode)) {
              return 'trap'
            }
          } else {
            if (cellCode === ' ') {
              return 'decoration_1' // floor
            } else if (cellCode === '0') {
              return 'unknown'
            }

            return 'basic_' + ('─│└┌┐┘├┤┬┴┼?.'.indexOf(cellCode) + 1)
          }
        }
      });
    </script>
    <style>
    #page {
      background: #fff;
      width: 100%;
      height: 100%;
    }
    /* work version */
    .tile {
      background-color: #efefef;
    }

    .floor {
      background-color: #ddd;
    }

    .wall {
      background-color: #bbb;
    }

    .player1 {
      background-color: #eee;
    }

    .player2 {
      background-color: #eeb;
    }

    .tile.treasure {
      background-color: #fb6;
    }

    .tile.trap {
      background-color: #ffd1d1;
    }

    .tile.unknown {
      background-color: #333;
    }

    .player-list {
      color: #ccc;
    }

    /* TODO:flexbox or grid */
    #player-list-container {
      min-width: 160px;
      width: 20%;
      float: left;
      border: 1px solid #111;
      /* DRY */
      height: 100px;
      background-color: #fafbfc;
      font-size: 16px;
      box-shadow: inset 0 1px 2px rgba(27,31,35,0.075);
    }

    .player-list .you {
      color: #000;
    }

    .player-list .current-turn {
      font-weight: bold;
    }

    #message-container {
      overflow-y: scroll;
      float: left;
      width: 80%;
      height: 100px;
      background-color: #fafbfc;
      font-size: 16px;
      box-shadow: inset 0 1px 2px rgba(27,31,35,0.075);
    }

    #message-container ul {
      list-style: none;
      padding: 0 0 0 10px;
      margin: 0;
    }

    #message-container span.general {
      color: #111;
    }

    #message-container span.success {
      color: #24af4c;
    }

    #message-container span.failure {
      color: #d84831;
    }

    #message-container span.event {
      color: #d8a931;
    }
    </style>
    <div id="page">
      <header>
        <div id="player-list-container">
          <ul class="player-list">
          </ul>
        </div>
        <div id="message-container">
          <ul>
          </ul>
        </div>
      </header>
      <div id="map-container"></div>
    </div>
  </body>
</html>
